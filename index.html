<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#065f46">
    <meta http-equiv="Permissions-Policy" content="camera=*, microphone=*">
    
    <title>Ramadhan Events - Fakultas Teknik UGM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Amiri:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0c4a6e 0%, #065f46 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .arabic-font {
            font-family: 'Amiri', serif;
        }
        
        /* Animated Islamic Pattern Background */
        .islamic-pattern {
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.03) 35px, rgba(255,255,255,.03) 70px),
                repeating-linear-gradient(-45deg, transparent, transparent 35px, rgba(255,255,255,.03) 35px, rgba(255,255,255,.03) 70px);
            position: relative;
        }
        
        .islamic-pattern::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(251, 191, 36, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(59, 130, 246, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        /* Floating Lanterns Animation */
        .lantern {
            position: fixed;
            font-size: 30px;
            opacity: 0.6;
            animation: floatLantern 15s ease-in-out infinite;
            pointer-events: none;
            z-index: 1;
        }
        
        @keyframes floatLantern {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            25% { transform: translateY(-30px) rotate(5deg); }
            50% { transform: translateY(-10px) rotate(-3deg); }
            75% { transform: translateY(-40px) rotate(3deg); }
        }
        
        /* Mosque Silhouette */
        .mosque-silhouette {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 150px;
            background: linear-gradient(to top, rgba(6, 78, 59, 0.5) 0%, transparent 100%);
            pointer-events: none;
            z-index: 0;
        }
        
        .mosque-silhouette::before {
            content: 'ðŸ•Œ';
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 80px;
            opacity: 0.2;
        }
        
        /* Star Animation */
        .star {
            position: fixed;
            width: 3px;
            height: 3px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }
        
        /* Shooting Star */
        .shooting-star {
            position: fixed;
            width: 100px;
            height: 2px;
            background: linear-gradient(to right, transparent, white, transparent);
            animation: shootingStar 3s ease-in-out infinite;
            opacity: 0;
        }
        
        @keyframes shootingStar {
            0% { transform: translateX(-100px) translateY(0); opacity: 0; }
            10% { opacity: 1; }
            30% { transform: translateX(calc(100vw + 100px)) translateY(100px); opacity: 0; }
            100% { opacity: 0; }
        }
        
        /* Crescent Moon with Glow */
        .crescent {
            position: fixed;
            top: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            box-shadow: 
                inset -15px 0 0 0 #fbbf24,
                0 0 30px rgba(251, 191, 36, 0.5),
                0 0 60px rgba(251, 191, 36, 0.3);
            animation: moonGlow 3s ease-in-out infinite;
            z-index: 1;
        }
        
        @keyframes moonGlow {
            0%, 100% { box-shadow: inset -15px 0 0 0 #fbbf24, 0 0 30px rgba(251, 191, 36, 0.5); }
            50% { box-shadow: inset -15px 0 0 0 #fbbf24, 0 0 50px rgba(251, 191, 36, 0.8); }
        }
        
        /* Particle Effect */
        .particle {
            position: fixed;
            width: 4px;
            height: 4px;
            background: #fbbf24;
            border-radius: 50%;
            pointer-events: none;
            animation: particleFloat 10s ease-in-out infinite;
        }
        
        @keyframes particleFloat {
            0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }
        
        /* Card Styles */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255,255,255,0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 30px 90px rgba(0, 0, 0, 0.35),
                0 0 0 1px rgba(255,255,255,0.2);
        }
        
        /* Glass Card */
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
        }
        
        /* Button Animations */
        .btn-primary {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.5);
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        /* Ticket Animation */
        @keyframes ticketFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(1deg); }
        }
        
        .ticket-float {
            animation: ticketFloat 4s ease-in-out infinite;
        }
        
        /* Scanner Frame */
        .scanner-frame {
            border: 3px solid #fbbf24;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.5);
            animation: scannerPulse 2s ease-in-out infinite;
            position: relative;
            background: #000;
        }
        
        @keyframes scannerPulse {
            0%, 100% { box-shadow: 0 0 30px rgba(251, 191, 36, 0.5); }
            50% { box-shadow: 0 0 60px rgba(251, 191, 36, 0.8); }
        }
        
        /* QR Scanner Responsive */
        #qr-reader {
            width: 100% !important;
            border: none !important;
        }
        
        #qr-reader video {
            width: 100% !important;
            height: auto !important;
            object-fit: cover !important;
            border-radius: 15px !important;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .modal.active {
            display: flex !important;
        }
        
        /* Success Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 20px 30px;
            border-radius: 15px;
            color: white;
            font-weight: 600;
            z-index: 100000;
            animation: slideIn 0.5s ease-out, slideOut 0.5s ease-in 3s forwards;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* Celebration Animation */
        .celebration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.95) 100%);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .celebration-content {
            text-align: center;
            animation: celebrationPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        @keyframes celebrationPop {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        .checkmark-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 40px;
            animation: checkPulse 1.5s ease-in-out infinite;
            box-shadow: 
                0 0 60px rgba(16, 185, 129, 0.6),
                0 0 120px rgba(16, 185, 129, 0.3);
        }
        
        @keyframes checkPulse {
            0%, 100% { 
                box-shadow: 0 0 60px rgba(16, 185, 129, 0.6), 0 0 120px rgba(16, 185, 129, 0.3);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 100px rgba(16, 185, 129, 0.9), 0 0 200px rgba(16, 185, 129, 0.5);
                transform: scale(1.05);
            }
        }
        
        .checkmark {
            font-size: 90px;
            color: white;
            animation: checkBounce 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.3s both;
        }
        
        @keyframes checkBounce {
            0% { transform: scale(0) rotate(-45deg); }
            50% { transform: scale(1.3) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        
        /* Confetti */
        .confetti {
            position: absolute;
            width: 12px;
            height: 12px;
            animation: confettiFall 4s ease-out forwards;
        }
        
        @keyframes confettiFall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(1080deg); opacity: 0; }
        }
        
        /* Firework */
        .firework {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: fireworkExplode 1.5s ease-out forwards;
        }
        
        @keyframes fireworkExplode {
            0% { transform: scale(0); opacity: 1; }
            50% { opacity: 1; }
            100% { transform: scale(30); opacity: 0; }
        }
        
        /* Star burst */
        .star-burst {
            position: absolute;
            font-size: 40px;
            animation: starBurst 2s ease-out forwards;
        }
        
        @keyframes starBurst {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.5) rotate(180deg); opacity: 1; }
            100% { transform: scale(0) rotate(360deg); opacity: 0; }
        }
        
        /* Event Badge */
        .event-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #78350f;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.5);
            animation: badgePulse 2s ease-in-out infinite;
            z-index: 10;
        }
        
        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* Section Title with Glow */
        .section-title {
            color: white;
            text-shadow: 
                2px 2px 4px rgba(0,0,0,0.5),
                0 0 30px rgba(251, 191, 36, 0.3);
        }
        
        /* Responsive */
        @media (max-width: 640px) {
            .card {
                border-radius: 16px;
                margin: 4px;
            }
            
            .crescent {
                width: 40px;
                height: 40px;
                top: 15px;
                right: 15px;
            }
        }
        
        /* Hidden Admin Button */
        .secret-admin-trigger {
            cursor: default;
            user-select: none;
        }
        
        /* Admin Login Modal */
        .admin-login-form {
            animation: fadeInUp 0.3s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Pulse animation for new visitor */
        .visitor-new {
            animation: newVisitorPulse 1s ease-out;
            background: rgba(16, 185, 129, 0.1);
        }
        
        @keyframes newVisitorPulse {
            0% { background: rgba(16, 185, 129, 0.5); }
            100% { background: rgba(16, 185, 129, 0.1); }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #059669 0%, #fbbf24 100%);
            border-radius: 10px;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Login button disabled state */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Lockout warning */
        .lockout-warning {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            text-align: center;
            font-size: 14px;
            animation: warningPulse 2s ease-in-out infinite;
        }
        
        @keyframes warningPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        /* Quota Badge */
        .quota-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .quota-full {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .quota-low {
            background: #fef3c7;
            color: #d97706;
        }
        
        .quota-available {
            background: #dcfce7;
            color: #16a34a;
        }
    </style>
</head>
<body class="islamic-pattern">
    <!-- Decorative Elements -->
    <div class="crescent"></div>
    <div class="mosque-silhouette"></div>
    <div id="stars-container"></div>
    <div id="lanterns-container"></div>
    <div id="particles-container"></div>
    <div id="shooting-stars-container"></div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <!-- Main Container -->
    <div id="app" class="relative z-10">
        
        <!-- Welcome/User Dashboard (Default) -->
        <div id="user-dashboard" class="min-h-screen p-3 sm:p-4 pb-24">
            <div class="max-w-6xl mx-auto">
                <!-- Header with Secret Admin Trigger -->
                <div class="card p-4 sm:p-6 mb-4 sm:mb-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                        <div class="secret-admin-trigger" id="secret-admin-btn">
                            <div class="flex items-center gap-3">
                                <div class="bg-gradient-to-br from-emerald-500 to-emerald-700 p-3 rounded-xl">
                                    <i class="fas fa-mosque text-2xl text-yellow-400"></i>
                                </div>
                                <div>
                                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Assalamu'alaikum</h2>
                                    <p class="text-xs sm:text-sm text-gray-600">Ramadhan FT UGM 1447 H</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="user-device-id" class="text-xs text-gray-400 hidden sm:block"></span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-3 sm:gap-4 mb-6">
                    <button onclick="openScanner()" class="card p-4 sm:p-6 hover:shadow-2xl transition-all cursor-pointer group">
                        <div class="flex flex-col items-center text-center">
                            <div class="bg-gradient-to-br from-emerald-500 to-emerald-700 p-4 rounded-2xl group-hover:scale-110 transition-transform mb-3">
                                <i class="fas fa-qrcode text-3xl text-white"></i>
                            </div>
                            <h3 class="text-sm sm:text-lg font-bold text-gray-800">Scan QR</h3>
                            <p class="text-xs text-gray-500 mt-1">Daftar Event</p>
                        </div>
                    </button>
                    
                    <div class="card p-4 sm:p-6">
                        <div class="flex flex-col items-center text-center">
                            <div class="bg-gradient-to-br from-yellow-500 to-yellow-700 p-4 rounded-2xl mb-3">
                                <i class="fas fa-ticket-alt text-3xl text-white"></i>
                            </div>
                            <h3 class="text-sm sm:text-lg font-bold text-gray-800">Total Tiket</h3>
                            <p class="text-2xl sm:text-3xl font-bold text-emerald-600 mt-1" id="total-tickets">0</p>
                        </div>
                    </div>
                </div>

                <!-- My Active Tickets -->
                <div class="mb-6">
                    <h3 class="section-title text-lg sm:text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-ticket-alt mr-2 text-yellow-400"></i>
                        Tiket Aktif Saya
                        <span class="ml-2 bg-yellow-500 text-yellow-900 text-xs px-3 py-1 rounded-full font-bold" id="active-ticket-count">0</span>
                    </h3>
                    <div id="active-tickets" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
                </div>

                <!-- Completed Tickets -->
                <div class="mb-6">
                    <h3 class="section-title text-lg sm:text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-check-circle mr-2 text-yellow-400"></i>
                        Tiket Selesai
                        <span class="ml-2 bg-gray-500 text-white text-xs px-3 py-1 rounded-full font-bold" id="completed-ticket-count">0</span>
                    </h3>
                    <div id="completed-tickets" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
                </div>

                <!-- Available Events -->
                <div class="mb-6">
                    <h3 class="section-title text-lg sm:text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-calendar-alt mr-2 text-yellow-400"></i>
                        Event Tersedia
                    </h3>
                    <div id="available-events" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
                </div>

                <!-- Past Events -->
                <div>
                    <h3 class="section-title text-lg sm:text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-history mr-2 text-yellow-400"></i>
                        Event Berakhir
                    </h3>
                    <div id="past-events" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="text-center mt-10 text-white/50 text-sm">
                    <p class="arabic-font text-lg mb-1">Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…</p>
                    <p>Marhaban Ya Ramadhan 1447 H</p>
                    <p class="text-xs mt-1">Fakultas Teknik UGM</p>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="hidden min-h-screen p-4">
            <div class="max-w-7xl mx-auto">
                <!-- Header -->
                <div class="card p-6 mb-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div class="flex items-center gap-4">
                            <div class="bg-gradient-to-br from-emerald-500 to-emerald-700 p-3 rounded-xl">
                                <i class="fas fa-user-shield text-2xl text-yellow-400"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">Dashboard Admin</h2>
                                <p class="text-sm text-gray-600">Kelola Event Ramadhan FT UGM</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openAdminSettings()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-all">
                                <i class="fas fa-cog mr-2"></i>Pengaturan
                            </button>
                            <button onclick="logoutAdmin()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-all">
                                <i class="fas fa-sign-out-alt mr-2"></i>Keluar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="card p-5">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs sm:text-sm text-gray-500">Total Event</p>
                                <p class="text-2xl sm:text-3xl font-bold text-gray-800" id="total-events">0</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-xl">
                                <i class="fas fa-calendar text-xl sm:text-2xl text-blue-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-5">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs sm:text-sm text-gray-500">Event Aktif</p>
                                <p class="text-2xl sm:text-3xl font-bold text-gray-800" id="active-events-count">0</p>
                            </div>
                            <div class="bg-green-100 p-3 rounded-xl">
                                <i class="fas fa-check-circle text-xl sm:text-2xl text-green-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-5">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs sm:text-sm text-gray-500">Total Pengunjung</p>
                                <p class="text-2xl sm:text-3xl font-bold text-gray-800" id="total-visitors">0</p>
                            </div>
                            <div class="bg-yellow-100 p-3 rounded-xl">
                                <i class="fas fa-users text-xl sm:text-2xl text-yellow-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-5">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs sm:text-sm text-gray-500">Unique Devices</p>
                                <p class="text-2xl sm:text-3xl font-bold text-gray-800" id="unique-devices">0</p>
                            </div>
                            <div class="bg-purple-100 p-3 rounded-xl">
                                <i class="fas fa-mobile-alt text-xl sm:text-2xl text-purple-600"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Create Event Button -->
                <button onclick="openCreateEventModal()" class="w-full md:w-auto btn-primary text-white px-8 py-4 rounded-xl font-semibold mb-6 flex items-center justify-center space-x-3">
                    <i class="fas fa-plus-circle text-xl"></i>
                    <span>Buat Event Baru</span>
                </button>

                <!-- Events List -->
                <div class="card p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-list mr-2 text-emerald-600"></i>
                        Daftar Event
                    </h3>
                    <div id="admin-events-list" class="space-y-3">
                    </div>
                </div>
            </div>
        </div>

        <!-- Ticket Display Screen -->
        <div id="ticket-screen" class="hidden min-h-screen flex items-center justify-center p-4">
            <div class="card w-full max-w-md p-8 text-center ticket-float relative">
                <button onclick="closeTicket()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
                
                <div class="mb-6">
                    <div class="inline-block p-4 bg-gradient-to-br from-emerald-600 to-emerald-800 rounded-full mb-4">
                        <i class="fas fa-ticket-alt text-4xl text-yellow-400"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2" id="ticket-event-name"></h2>
                    <p class="text-sm text-gray-600" id="ticket-event-date"></p>
                </div>

                <div class="bg-gradient-to-br from-emerald-50 to-yellow-50 p-6 rounded-2xl mb-6 border-2 border-dashed border-emerald-300">
                    <p class="text-sm text-gray-600 font-semibold mb-3">KODE EVENT</p>
                    <div class="bg-white p-4 rounded-xl mb-4 shadow-inner">
                        <p class="text-3xl font-bold text-emerald-700 tracking-widest" id="ticket-unique-code"></p>
                    </div>
                    <div id="ticket-qr-code" class="mx-auto flex justify-center"></div>
                </div>

                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6 rounded-r-xl">
                    <p class="text-sm text-yellow-800 font-bold">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        TIKET: Tunjukkan ini ke petugas
                    </p>
                    <p class="text-xs text-yellow-700 mt-2">Jangan klik tombol "Selesai" sebelum diverifikasi!</p>
                </div>

                <button onclick="completeTicket()" class="w-full bg-gradient-to-r from-emerald-500 to-emerald-700 hover:from-emerald-600 hover:to-emerald-800 text-white py-4 px-6 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg">
                    <i class="fas fa-check-circle mr-2"></i>Selesai & Verifikasi
                </button>
                <p class="text-xs text-gray-500 mt-3">
                    <i class="fas fa-info-circle mr-1"></i>
                    Klik HANYA setelah petugas memverifikasi tiket Anda
                </p>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="modal">
        <div class="card w-full max-w-md p-8 m-4 admin-login-form">
            <div class="text-center mb-6">
                <div class="inline-block p-4 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-full mb-4">
                    <i class="fas fa-lock text-3xl text-white"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800">Login Admin</h3>
                <p class="text-sm text-gray-600 mt-1">Masukkan password admin</p>
            </div>
            
            <form id="admin-login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                    <input type="password" id="admin-password" required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                        placeholder="Masukkan password...">
                </div>
                
                <button type="submit" class="w-full btn-primary text-white py-4 rounded-xl font-semibold">
                    <i class="fas fa-sign-in-alt mr-2"></i>Masuk
                </button>
            </form>
            
            <button onclick="closeAdminLogin()" class="w-full mt-3 text-gray-500 hover:text-gray-700 py-2">
                Batal
            </button>
        </div>
    </div>

    <!-- Admin Settings Modal -->
    <div id="admin-settings-modal" class="modal">
        <div class="card w-full max-w-md p-8 m-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Pengaturan Admin</h3>
                <button onclick="closeAdminSettings()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <form id="change-password-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Password Lama</label>
                    <input type="password" id="old-password" required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Password Baru</label>
                    <input type="password" id="new-password" required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Konfirmasi Password Baru</label>
                    <input type="password" id="confirm-password" required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500">
                </div>
                
                <button type="submit" class="w-full btn-primary text-white py-4 rounded-xl font-semibold">
                    <i class="fas fa-save mr-2"></i>Simpan Password Baru
                </button>
            </form>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div id="scanner-modal" class="modal">
        <div class="card w-full max-w-md p-4 sm:p-6 m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg sm:text-xl font-bold text-gray-800">Scan QR Event</h3>
                <button onclick="closeScanner()" class="text-gray-500 hover:text-gray-700 p-2">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div id="scanner-status" class="mb-3 p-3 bg-blue-50 rounded-lg text-center">
                <i class="fas fa-spinner fa-spin mr-2 text-blue-600"></i>
                <span class="text-sm text-blue-700">Memuat kamera...</span>
            </div>
            
            <div id="qr-reader-container" class="scanner-frame overflow-hidden rounded-xl" style="min-height: 280px;">
                <div id="qr-reader" style="width: 100%;"></div>
            </div>
            
            <p class="text-xs text-gray-500 text-center mt-4">
                <i class="fas fa-info-circle mr-1"></i>
                Arahkan kamera ke QR Code event
            </p>
            
            <button onclick="switchCamera()" class="w-full mt-3 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 px-4 rounded-lg text-sm font-medium">
                <i class="fas fa-sync-alt mr-2"></i>Ganti Kamera
            </button>
        </div>
    </div>

    <!-- Create Event Modal -->
    <div id="create-event-modal" class="modal">
        <div class="card w-full max-w-2xl p-8 m-4 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Buat Event Baru</h3>
                <button onclick="closeCreateEventModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <form id="create-event-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Event</label>
                    <input type="text" id="event-name" required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500"
                        placeholder="Contoh: Buka Puasa Bersama">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Deskripsi</label>
                    <textarea id="event-description" rows="3" required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500"
                        placeholder="Deskripsi singkat event..."></textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Tanggal & Jam Mulai</label>
                        <input type="datetime-local" id="event-start" required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Tanggal & Jam Selesai</label>
                        <input type="datetime-local" id="event-end" required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Lokasi</label>
                    <input type="text" id="event-location" required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500"
                        placeholder="Contoh: Aula Fakultas Teknik">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Kuota Tiket</label>
                    <input type="number" id="event-quota" required min="1" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500"
                        placeholder="Contoh: 100">
                    <p class="text-xs text-gray-500 mt-1">Jumlah maksimal pengunjung yang bisa mendaftar</p>
                </div>
                
                <button type="submit" class="w-full btn-primary text-white py-4 rounded-xl font-semibold text-lg">
                    <i class="fas fa-check-circle mr-2"></i>Buat Event
                </button>
            </form>
        </div>
    </div>

    <!-- Event Detail Modal (Fullscreen) -->
    <div id="event-detail-modal" class="modal">
        <div class="w-full h-full bg-gradient-to-br from-emerald-50 to-blue-50 overflow-y-auto">
            <!-- Header Fixed -->
            <div class="sticky top-0 bg-white border-b border-gray-200 shadow-md z-50 p-4 sm:p-6">
                <div class="max-w-7xl mx-auto flex justify-between items-center">
                    <h3 class="text-xl sm:text-3xl font-bold text-gray-800" id="detail-event-name"></h3>
                    <button onclick="closeEventDetailModal()" class="bg-red-500 hover:bg-red-600 text-white p-3 rounded-full transition-all">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Content -->
            <div class="max-w-7xl mx-auto p-4 sm:p-8">
            
            <!-- QR Code Section (Large, Centered) -->
            <div class="mb-8">
                <div class="text-center mb-6">
                    <h4 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2 flex items-center justify-center">
                        <i class="fas fa-qrcode mr-3 text-emerald-600"></i>
                        QR Code Event (Auto Refresh)
                    </h4>
                    <p class="text-gray-600">Tampilkan QR ini ke layar besar untuk di-scan pengunjung</p>
                </div>
                <div class="flex justify-center">
                    <div class="bg-white p-6 sm:p-10 rounded-3xl shadow-2xl border-4 border-emerald-500 inline-block">
                        <div id="detail-event-qr" class="flex justify-center items-center"></div>
                        <p class="text-center text-sm text-gray-600 mt-4">
                            <i class="fas fa-sync-alt mr-2 text-emerald-600"></i>
                            Refresh otomatis setiap 5 detik
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Event Info & Stats -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="space-y-3">
                    <h4 class="text-xl font-bold text-gray-700 flex items-center">
                        <i class="fas fa-info-circle mr-2 text-emerald-600"></i>Informasi Event
                    </h4>
                    <div class="bg-white p-6 rounded-xl shadow-lg space-y-3 text-base">
                        <p><span class="font-semibold text-gray-600">Deskripsi:</span> <span id="detail-event-desc" class="text-gray-800"></span></p>
                        <p><span class="font-semibold text-gray-600">Lokasi:</span> <span id="detail-event-location" class="text-gray-800"></span></p>
                        <p><span class="font-semibold text-gray-600">Mulai:</span> <span id="detail-event-start" class="text-gray-800"></span></p>
                        <p><span class="font-semibold text-gray-600">Selesai:</span> <span id="detail-event-end" class="text-gray-800"></span></p>
                        <p><span class="font-semibold text-gray-600">Status:</span> <span id="detail-event-status"></span></p>
                        <p><span class="font-semibold text-gray-600">Kode Event:</span> <span id="detail-event-code" class="font-bold text-emerald-700 text-lg"></span></p>
                        <p><span class="font-semibold text-gray-600">Kuota:</span> <span id="detail-event-quota"></span></p>
                    </div>
                </div>
                
                <div>
                    <h4 class="text-xl font-bold text-gray-700 flex items-center mb-3">
                        <i class="fas fa-chart-bar mr-2 text-blue-600"></i>Statistik Real-Time
                    </h4>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center p-4 bg-emerald-50 rounded-lg">
                                <p class="text-3xl font-bold text-emerald-600" id="detail-visitors-count-display">0</p>
                                <p class="text-sm text-gray-600 mt-1">Total Pengunjung</p>
                            </div>
                            <div class="text-center p-4 bg-blue-50 rounded-lg">
                                <p class="text-3xl font-bold text-blue-600" id="detail-quota-display">-</p>
                                <p class="text-sm text-gray-600 mt-1">Kuota Tersisa</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Visitors Table -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-bold text-gray-700 flex items-center">
                        <i class="fas fa-users mr-2 text-emerald-600"></i>
                        Daftar Pengunjung (<span id="detail-visitors-count">0</span>)
                    </h4>
                    <button onclick="exportVisitors()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all">
                        <i class="fas fa-file-excel mr-2"></i>Export Excel
                    </button>
                </div>
                <div class="overflow-x-auto bg-gray-50 rounded-xl">
                    <table class="w-full text-sm">
                        <thead class="bg-emerald-600 text-white">
                            <tr>
                                <th class="px-4 py-3 text-left rounded-tl-xl">No</th>
                                <th class="px-4 py-3 text-left">Waktu Scan</th>
                                <th class="px-4 py-3 text-left">Device ID</th>
                                <th class="px-4 py-3 text-left">Device Info</th>
                                <th class="px-4 py-3 text-left rounded-tr-xl">Browser</th>
                            </tr>
                        </thead>
                        <tbody id="visitors-table-body" class="divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Action Buttons (Fixed Bottom) -->
            <div class="sticky bottom-0 bg-white border-t border-gray-200 shadow-lg p-4 sm:p-6">
                <div class="max-w-7xl mx-auto flex flex-wrap gap-3">
                    <button onclick="openEditEventModal()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-4 px-6 rounded-xl font-semibold transition-all shadow-lg">
                        <i class="fas fa-edit mr-2"></i>Edit Event
                    </button>
                    <button onclick="deleteEvent()" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-4 px-6 rounded-xl font-semibold transition-all shadow-lg">
                        <i class="fas fa-trash mr-2"></i>Hapus Event
                    </button>
                    <button onclick="closeEventDetailModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-4 px-6 rounded-xl font-semibold transition-all shadow-lg">
                        <i class="fas fa-times mr-2"></i>Tutup
                    </button>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Edit Event Modal -->
    <div id="edit-event-modal" class="modal">
        <div class="card w-full max-w-2xl p-8 m-4 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Edit Event</h3>
                <button onclick="closeEditEventModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <form id="edit-event-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Event</label>
                    <input type="text" id="edit-event-name" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Deskripsi</label>
                    <textarea id="edit-event-description" rows="3" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500"></textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Tanggal Mulai</label>
                        <input type="datetime-local" id="edit-event-start" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Tanggal Selesai</label>
                        <input type="datetime-local" id="edit-event-end" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Lokasi</label>
                    <input type="text" id="edit-event-location" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Kuota Tiket</label>
                    <input type="number" id="edit-event-quota" required min="1" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500">
                </div>
                
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 btn-primary text-white py-4 rounded-xl font-semibold">
                        <i class="fas fa-save mr-2"></i>Simpan
                    </button>
                    <button type="button" onclick="closeEditEventModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-4 rounded-xl font-semibold">
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Celebration Overlay -->
    <div id="celebration-overlay" class="celebration-overlay" style="display: none;">
        <div id="confetti-container"></div>
        <div class="celebration-content">
            <div class="checkmark-circle">
                <i class="fas fa-check checkmark"></i>
            </div>
            <h2 class="text-4xl sm:text-5xl font-bold text-white mb-4">Terima Kasih!</h2>
            <p class="text-xl sm:text-2xl text-emerald-400 mb-2 arabic-font">Ø¬Ø²Ø§Ùƒ Ø§Ù„Ù„Ù‡ Ø®ÙŠØ±Ø§</p>
            <p class="text-lg text-gray-300 mb-6">Jazakallahu Khairan</p>
            <div class="text-6xl mb-6">ðŸŽ‰ðŸŒ™âœ¨</div>
            <p class="text-sm text-gray-400">Semoga mendapat keberkahan di bulan Ramadhan</p>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyAY4SEN3ei37fnc7_B6Edo1B_YrdnrSq3A",
            authDomain: "first-a0709.firebaseapp.com",
            databaseURL: "https://first-a0709-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "first-a0709",
            storageBucket: "first-a0709.firebasestorage.app",
            messagingSenderId: "1045107787444",
            appId: "1:1045107787444:web:bf1a5f50cc1f8808f739e1",
            measurementId: "G-VET25W16XB"
        };

        // Initialize Firebase
        let firebaseApp, database;
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("âœ… Firebase connected!");
        } catch (error) {
            console.error("âŒ Firebase error:", error);
        }

        // ============================================
        // DATABASE CLASS
        // ============================================
        class FirebaseDB {
            constructor() {
                this.db = database;
                this.eventsRef = this.db.ref('events');
                this.ticketsRef = this.db.ref('tickets');
                this.settingsRef = this.db.ref('settings');
                this.init();
            }
            
            init() {
                if (!localStorage.getItem('deviceId')) {
                    localStorage.setItem('deviceId', this.generateDeviceId());
                }
                // Initialize admin password if not exists
                this.settingsRef.child('adminPassword').once('value', snapshot => {
                    if (!snapshot.exists()) {
                        this.settingsRef.child('adminPassword').set('admin123');
                    }
                });
            }
            
            generateDeviceId() {
                const nav = navigator;
                const screen = window.screen;
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl');
                let fingerprint = nav.userAgent + screen.width + screen.height + screen.colorDepth;
                if (gl) {
                    fingerprint += gl.getParameter(gl.VENDOR) + gl.getParameter(gl.RENDERER);
                }
                return 'DEV-' + this.hashCode(fingerprint);
            }
            
            hashCode(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(36).toUpperCase();
            }
            
            getDeviceId() {
                return localStorage.getItem('deviceId');
            }
            
            async verifyAdminPassword(password) {
                const snapshot = await this.settingsRef.child('adminPassword').once('value');
                return snapshot.val() === password;
            }
            
            async changeAdminPassword(oldPassword, newPassword) {
                const isValid = await this.verifyAdminPassword(oldPassword);
                if (!isValid) throw new Error('Password lama salah');
                await this.settingsRef.child('adminPassword').set(newPassword);
            }
            
            async createEvent(eventData) {
                const eventId = 'evt-' + Date.now();
                const eventCode = 'EVT-' + Date.now().toString(36).toUpperCase().slice(-4) + '-' + Math.random().toString(36).slice(2, 5).toUpperCase();
                await this.eventsRef.child(eventId).set({
                    ...eventData,
                    id: eventId,
                    eventCode: eventCode,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    visitors: {}
                });
                return { eventId, eventCode };
            }
            
            async updateEvent(eventId, eventData) {
                await this.eventsRef.child(eventId).update(eventData);
            }
            
            async deleteEvent(eventId) {
                await this.eventsRef.child(eventId).remove();
                // Also delete all tickets for this event
                const ticketsSnapshot = await this.ticketsRef.once('value');
                const allTickets = ticketsSnapshot.val() || {};
                for (const deviceId in allTickets) {
                    if (allTickets[deviceId][eventId]) {
                        await this.ticketsRef.child(deviceId).child(eventId).remove();
                    }
                }
            }
            
            onEventsChange(callback) {
                this.eventsRef.on('value', snapshot => {
                    const data = snapshot.val();
                    callback(data ? Object.values(data) : []);
                });
            }
            
            onEventVisitorsChange(eventId, callback) {
                this.eventsRef.child(eventId).child('visitors').on('value', snapshot => {
                    const data = snapshot.val();
                    callback(data ? Object.values(data) : []);
                });
            }
            
            offEventVisitorsChange(eventId) {
                this.eventsRef.child(eventId).child('visitors').off();
            }
            
            async addVisitor(eventId, visitorData) {
                const deviceId = this.getDeviceId();
                await this.eventsRef.child(eventId).child('visitors').child(deviceId).set({
                    ...visitorData,
                    deviceId: deviceId,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
            
            async checkVisitorExists(eventId, deviceId) {
                const snapshot = await this.eventsRef.child(eventId).child('visitors').child(deviceId).once('value');
                return snapshot.exists();
            }
            
            async createTicket(ticketData) {
                const deviceId = this.getDeviceId();
                await this.ticketsRef.child(deviceId).child(ticketData.eventId).set({
                    ...ticketData,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
            }
            
            async completeTicket(eventId) {
                const deviceId = this.getDeviceId();
                await this.ticketsRef.child(deviceId).child(eventId).update({
                    completed: true,
                    completedAt: firebase.database.ServerValue.TIMESTAMP
                });
            }
            
            onUserTicketsChange(callback) {
                const deviceId = this.getDeviceId();
                this.ticketsRef.child(deviceId).on('value', snapshot => {
                    const data = snapshot.val();
                    callback(data ? Object.values(data) : []);
                });
            }
            
            offEventsChange() {
                this.eventsRef.off();
            }
            
            offUserTicketsChange() {
                this.ticketsRef.child(this.getDeviceId()).off();
            }
        }

        const db = new FirebaseDB();
        
        // ============================================
        // STATE VARIABLES
        // ============================================
        let isAdmin = false;
        let currentEventId = null;
        let cachedEvents = [];
        let cachedTickets = [];
        let qrScanner = null;
        let qrRefreshInterval = null;
        let currentFacingMode = "environment";
        let scannerIsRunning = false;
        let adminClickCount = 0;
        let adminClickTimer = null;
        let previousVisitorCount = 0;

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            createDecorations();
            initSecretAdminButton();
            loadUserDashboard();
            
            // Show device ID
            document.getElementById('user-device-id').textContent = db.getDeviceId();
            
            // Check URL hash untuk auto-join dari scan eksternal
            checkURLHashForEventJoin();
        });
        
        // Handle URL hash untuk join event dari aplikasi QR eksternal
        function checkURLHashForEventJoin() {
            const hash = window.location.hash;
            if (hash.startsWith('#join?')) {
                const params = new URLSearchParams(hash.substring(6));
                const eventId = params.get('eventId');
                const eventCode = params.get('code');
                const timestamp = params.get('ts');
                
                if (eventId && eventCode && timestamp) {
                    // Validasi timestamp (max 6 detik)
                    const qrTime = new Date(timestamp);
                    const now = new Date();
                    const diffSeconds = (now - qrTime) / 1000;
                    
                    if (diffSeconds > 6) {
                        showNotification('error', 'QR Code sudah kadaluarsa! Scan yang baru.');
                        window.location.hash = '';
                        return;
                    }
                    
                    // Tunggu events loaded
                    setTimeout(() => {
                        const event = cachedEvents.find(e => e.id === eventId && e.eventCode === eventCode);
                        
                        if (!event) {
                            showNotification('error', 'Event tidak ditemukan!');
                            window.location.hash = '';
                            return;
                        }
                        
                        // Check apakah sudah terdaftar
                        if (cachedTickets.some(t => t.eventId === event.id)) {
                            showNotification('error', 'Anda sudah terdaftar di event ini!');
                            window.location.hash = '';
                            return;
                        }
                        
                        // Auto-register
                        registerToEvent(event).then(() => {
                            window.location.hash = '';
                        });
                    }, 1000);
                }
            }
        }

        function createDecorations() {
            // Stars
            const starsContainer = document.getElementById('stars-container');
            for (let i = 0; i < 80; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 60 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.animationDuration = (2 + Math.random() * 2) + 's';
                starsContainer.appendChild(star);
            }
            
            // Lanterns
            const lanternsContainer = document.getElementById('lanterns-container');
            const lanternEmojis = ['ðŸ®', 'ðŸª”', 'âœ¨'];
            for (let i = 0; i < 6; i++) {
                const lantern = document.createElement('div');
                lantern.className = 'lantern';
                lantern.textContent = lanternEmojis[i % lanternEmojis.length];
                lantern.style.left = (10 + i * 15) + '%';
                lantern.style.top = (10 + Math.random() * 20) + '%';
                lantern.style.animationDelay = i * 0.5 + 's';
                lanternsContainer.appendChild(lantern);
            }
            
            // Particles
            const particlesContainer = document.getElementById('particles-container');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 10 + 's';
                particle.style.animationDuration = (8 + Math.random() * 4) + 's';
                particlesContainer.appendChild(particle);
            }
            
            // Shooting stars
            const shootingContainer = document.getElementById('shooting-stars-container');
            for (let i = 0; i < 3; i++) {
                const shooting = document.createElement('div');
                shooting.className = 'shooting-star';
                shooting.style.top = (10 + Math.random() * 30) + '%';
                shooting.style.animationDelay = (i * 5 + Math.random() * 3) + 's';
                shootingContainer.appendChild(shooting);
            }
        }

        // ============================================
        // SECRET ADMIN BUTTON (Click 3x)
        // ============================================
        function initSecretAdminButton() {
            const btn = document.getElementById('secret-admin-btn');
            btn.addEventListener('click', () => {
                adminClickCount++;
                
                if (adminClickTimer) clearTimeout(adminClickTimer);
                
                adminClickTimer = setTimeout(() => {
                    adminClickCount = 0;
                }, 1000);
                
                if (adminClickCount >= 3) {
                    adminClickCount = 0;
                    openAdminLogin();
                }
            });
        }

        // ============================================
        // BRUTE FORCE PROTECTION
        // ============================================
        let loginAttempts = 0;
        let lockoutUntil = 0;
        const MAX_ATTEMPTS = 5;
        const LOCKOUT_DURATION = 60000; // 1 menit
        const ATTEMPT_DELAY = 2000; // 2 detik delay setelah gagal
        let isLoginProcessing = false;

        function checkLockout() {
            const now = Date.now();
            if (lockoutUntil > now) {
                const remainingSeconds = Math.ceil((lockoutUntil - now) / 1000);
                return { locked: true, remaining: remainingSeconds };
            }
            return { locked: false, remaining: 0 };
        }

        function recordFailedAttempt() {
            loginAttempts++;
            if (loginAttempts >= MAX_ATTEMPTS) {
                lockoutUntil = Date.now() + LOCKOUT_DURATION;
                loginAttempts = 0;
            }
        }

        function resetLoginAttempts() {
            loginAttempts = 0;
            lockoutUntil = 0;
        }

        // ============================================
        // ADMIN LOGIN
        // ============================================
        function openAdminLogin() {
            const lockStatus = checkLockout();
            if (lockStatus.locked) {
                showNotification('error', `Terlalu banyak percobaan! Tunggu ${lockStatus.remaining} detik.`);
                return;
            }
            document.getElementById('admin-login-modal').classList.add('active');
            document.getElementById('admin-password').focus();
            updateLoginButton(false);
        }

        function closeAdminLogin() {
            document.getElementById('admin-login-modal').classList.remove('active');
            document.getElementById('admin-password').value = '';
            updateLoginButton(false);
        }

        function updateLoginButton(disabled, text = null) {
            const btn = document.querySelector('#admin-login-form button[type="submit"]');
            if (btn) {
                btn.disabled = disabled;
                if (text) {
                    btn.innerHTML = text;
                } else {
                    btn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Masuk';
                }
                btn.style.opacity = disabled ? '0.6' : '1';
                btn.style.cursor = disabled ? 'not-allowed' : 'pointer';
            }
        }

        document.getElementById('admin-login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Check if already processing
            if (isLoginProcessing) return;
            
            // Check lockout
            const lockStatus = checkLockout();
            if (lockStatus.locked) {
                showNotification('error', `Akun terkunci! Tunggu ${lockStatus.remaining} detik.`);
                return;
            }
            
            const password = document.getElementById('admin-password').value;
            
            if (!password) {
                showNotification('error', 'Masukkan password!');
                return;
            }
            
            isLoginProcessing = true;
            updateLoginButton(true, '<i class="fas fa-spinner fa-spin mr-2"></i>Memverifikasi...');
            
            try {
                const isValid = await db.verifyAdminPassword(password);
                
                if (isValid) {
                    resetLoginAttempts();
                    isAdmin = true;
                    isLoginProcessing = false;
                    closeAdminLogin();
                    showAdminDashboard();
                    showNotification('success', 'Login berhasil!');
                } else {
                    recordFailedAttempt();
                    const lockStatus = checkLockout();
                    
                    if (lockStatus.locked) {
                        showNotification('error', `Terlalu banyak percobaan salah! Akun terkunci selama ${lockStatus.remaining} detik.`);
                        closeAdminLogin();
                    } else {
                        const attemptsLeft = MAX_ATTEMPTS - loginAttempts;
                        showNotification('error', `Password salah! Sisa percobaan: ${attemptsLeft}`);
                        
                        // Delay sebelum bisa coba lagi
                        updateLoginButton(true, `<i class="fas fa-clock mr-2"></i>Tunggu 2 detik...`);
                        await new Promise(resolve => setTimeout(resolve, ATTEMPT_DELAY));
                    }
                    
                    document.getElementById('admin-password').value = '';
                    isLoginProcessing = false;
                    updateLoginButton(false);
                }
            } catch (error) {
                isLoginProcessing = false;
                updateLoginButton(false);
                showNotification('error', 'Gagal login: ' + error.message);
            }
        });

        function logoutAdmin() {
            isAdmin = false;
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById('user-dashboard').classList.remove('hidden');
            showNotification('success', 'Berhasil logout');
        }

        function showAdminDashboard() {
            document.getElementById('user-dashboard').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.remove('hidden');
            loadAdminDashboard();
        }

        // ============================================
        // ADMIN SETTINGS
        // ============================================
        function openAdminSettings() {
            document.getElementById('admin-settings-modal').classList.add('active');
        }

        function closeAdminSettings() {
            document.getElementById('admin-settings-modal').classList.remove('active');
            document.getElementById('change-password-form').reset();
        }

        document.getElementById('change-password-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const oldPass = document.getElementById('old-password').value;
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;
            
            if (newPass !== confirmPass) {
                showNotification('error', 'Password baru tidak cocok!');
                return;
            }
            
            if (newPass.length < 4) {
                showNotification('error', 'Password minimal 4 karakter!');
                return;
            }
            
            try {
                await db.changeAdminPassword(oldPass, newPass);
                closeAdminSettings();
                showNotification('success', 'Password berhasil diubah!');
            } catch (error) {
                showNotification('error', error.message);
            }
        });

        // ============================================
        // USER DASHBOARD
        // ============================================
        function loadUserDashboard() {
            db.onEventsChange(events => {
                cachedEvents = events;
                renderUserEvents();
            });
            
            db.onUserTicketsChange(tickets => {
                cachedTickets = tickets;
                renderUserEvents();
            });
        }

        function renderUserEvents() {
            const now = new Date();
            
            // Filter tickets
            const activeTickets = cachedTickets.filter(t => {
                const event = cachedEvents.find(e => e.id === t.eventId);
                return event && !t.completed && new Date(event.endDate) > now;
            });
            
            const completedTickets = cachedTickets.filter(t => t.completed);
            
            // Filter events
            const availableEvents = cachedEvents.filter(e => {
                const hasTicket = cachedTickets.some(t => t.eventId === e.id);
                return !hasTicket && new Date(e.endDate) > now;
            });
            
            const pastEvents = cachedEvents.filter(e => new Date(e.endDate) <= now);
            
            // Update counts
            document.getElementById('active-ticket-count').textContent = activeTickets.length;
            document.getElementById('completed-ticket-count').textContent = completedTickets.length;
            document.getElementById('total-tickets').textContent = activeTickets.length;
            
            // Render sections
            renderSection('active-tickets', activeTickets, 'ticket-active');
            renderSection('completed-tickets', completedTickets, 'ticket-completed');
            renderSection('available-events', availableEvents, 'event-available');
            renderSection('past-events', pastEvents, 'event-past');
        }

        function renderSection(containerId, items, type) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (items.length === 0) {
                const emptyMessages = {
                    'ticket-active': { icon: 'fa-ticket-alt', text: 'Belum ada tiket aktif', sub: 'Scan QR untuk mendapatkan tiket' },
                    'ticket-completed': { icon: 'fa-check-circle', text: 'Belum ada tiket selesai', sub: '' },
                    'event-available': { icon: 'fa-calendar-alt', text: 'Tidak ada event tersedia', sub: '' },
                    'event-past': { icon: 'fa-history', text: 'Belum ada event berakhir', sub: '' }
                };
                const msg = emptyMessages[type];
                container.innerHTML = `
                    <div class="card p-6 col-span-full text-center">
                        <i class="fas ${msg.icon} text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">${msg.text}</p>
                        ${msg.sub ? `<p class="text-sm text-gray-400 mt-1">${msg.sub}</p>` : ''}
                    </div>
                `;
                return;
            }
            
            container.innerHTML = items.map(item => {
                if (type.startsWith('ticket')) {
                    const event = cachedEvents.find(e => e.id === item.eventId);
                    if (!event) return '';
                    return createTicketCard(event, item, type === 'ticket-completed');
                } else {
                    return createEventCard(item, type === 'event-past');
                }
            }).join('');
        }

        function createTicketCard(event, ticket, isCompleted) {
            return `
                <div class="card p-5 relative overflow-hidden ${isCompleted ? 'opacity-60' : ''}">
                    ${isCompleted ? 
                        '<div class="absolute top-3 right-3 bg-gray-500 text-white px-3 py-1 rounded-full text-xs font-bold"><i class="fas fa-check mr-1"></i>SELESAI</div>' : 
                        '<div class="event-badge"><i class="fas fa-star mr-1"></i>AKTIF</div>'}
                    
                    <div class="flex items-start gap-3 mb-4">
                        <div class="bg-gradient-to-br ${isCompleted ? 'from-gray-400 to-gray-600' : 'from-emerald-500 to-emerald-700'} p-3 rounded-xl shrink-0">
                            <i class="fas fa-ticket-alt text-xl text-white"></i>
                        </div>
                        <div class="min-w-0">
                            <h4 class="font-bold text-gray-800 truncate">${event.name}</h4>
                            <p class="text-sm text-gray-500 truncate">${event.description}</p>
                        </div>
                    </div>
                    
                    <div class="space-y-1.5 text-sm text-gray-600 mb-4">
                        <p class="flex items-center"><i class="fas fa-map-marker-alt mr-2 text-emerald-500 w-4"></i><span class="truncate">${event.location}</span></p>
                        <p class="flex items-center"><i class="fas fa-calendar mr-2 text-emerald-500 w-4"></i>${formatDate(new Date(event.startDate))}</p>
                        <p class="flex items-center"><i class="fas fa-key mr-2 text-yellow-500 w-4"></i><span class="font-bold text-emerald-700">${event.eventCode}</span></p>
                    </div>
                    
                    ${!isCompleted ? `
                        <button onclick="showTicket('${event.id}')" class="w-full btn-primary text-white py-3 rounded-xl font-semibold">
                            <i class="fas fa-qrcode mr-2"></i>Buka Tiket
                        </button>
                    ` : `
                        <div class="text-center py-3 bg-gray-100 rounded-xl text-gray-500 text-sm">
                            <i class="fas fa-check-circle mr-2"></i>Sudah Digunakan
                        </div>
                    `}
                </div>
            `;
        }

        function createEventCard(event, isPast) {
            const visitorsCount = event.visitors ? Object.keys(event.visitors).length : 0;
            const quota = event.quota || 0;
            const available = quota - visitorsCount;
            const percentage = quota > 0 ? (visitorsCount / quota) * 100 : 0;
            
            let quotaClass = 'quota-available';
            let quotaText = `${available} tersisa`;
            if (available === 0) {
                quotaClass = 'quota-full';
                quotaText = 'Penuh';
            } else if (percentage >= 80) {
                quotaClass = 'quota-low';
            }
            
            return `
                <div class="card p-5 ${isPast ? 'opacity-60' : ''}">
                    <div class="flex items-start gap-3 mb-4">
                        <div class="bg-gradient-to-br ${isPast ? 'from-gray-400 to-gray-600' : 'from-blue-500 to-blue-700'} p-3 rounded-xl shrink-0">
                            <i class="fas ${isPast ? 'fa-calendar-times' : 'fa-calendar-plus'} text-xl text-white"></i>
                        </div>
                        <div class="min-w-0 flex-1">
                            <h4 class="font-bold text-gray-800 truncate">${event.name}</h4>
                            <p class="text-sm text-gray-500 truncate">${event.description}</p>
                        </div>
                    </div>
                    
                    <div class="space-y-1.5 text-sm text-gray-600 mb-3">
                        <p class="flex items-center"><i class="fas fa-map-marker-alt mr-2 ${isPast ? 'text-gray-400' : 'text-blue-500'} w-4"></i><span class="truncate">${event.location}</span></p>
                        <p class="flex items-center"><i class="fas fa-calendar mr-2 ${isPast ? 'text-gray-400' : 'text-blue-500'} w-4"></i>${formatDate(new Date(event.startDate))}</p>
                    </div>
                    
                    ${!isPast && quota > 0 ? `
                        <div class="mb-3">
                            <span class="quota-badge ${quotaClass}">
                                <i class="fas fa-users"></i>
                                ${quotaText}
                            </span>
                        </div>
                    ` : ''}
                    
                    <div class="text-center py-3 ${isPast ? 'bg-gray-100 text-gray-500' : available > 0 ? 'bg-blue-50 text-blue-600' : 'bg-red-50 text-red-600'} rounded-xl text-sm">
                        <i class="fas ${isPast ? 'fa-clock' : available > 0 ? 'fa-qrcode' : 'fa-ban'} mr-2"></i>
                        ${isPast ? 'Event Telah Berakhir' : available > 0 ? 'Scan QR untuk bergabung' : 'Kuota Penuh'}
                    </div>
                </div>
            `;
        }

        // ============================================
        // TICKET FUNCTIONS
        // ============================================
        let currentTicketEventId = null;

        function showTicket(eventId) {
            const event = cachedEvents.find(e => e.id === eventId);
            const ticket = cachedTickets.find(t => t.eventId === eventId);
            
            if (!event || !ticket) return;
            if (ticket.completed) {
                showNotification('error', 'Tiket ini sudah digunakan!');
                return;
            }
            
            currentTicketEventId = eventId;
            
            document.getElementById('ticket-event-name').textContent = event.name;
            document.getElementById('ticket-event-date').textContent = formatDate(new Date(event.startDate));
            document.getElementById('ticket-unique-code').textContent = event.eventCode;
            
            // Generate QR
            const qrContainer = document.getElementById('ticket-qr-code');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: `EVENT:${event.eventCode}|USER:${db.getDeviceId()}`,
                width: 150,
                height: 150,
                colorDark: "#047857",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            document.getElementById('user-dashboard').classList.add('hidden');
            document.getElementById('ticket-screen').classList.remove('hidden');
        }

        function closeTicket() {
            currentTicketEventId = null;
            document.getElementById('ticket-screen').classList.add('hidden');
            document.getElementById('user-dashboard').classList.remove('hidden');
        }

        async function completeTicket() {
            if (!currentTicketEventId) return;
            
            if (!confirm('Apakah petugas sudah memverifikasi tiket Anda?\n\nTiket tidak dapat digunakan lagi setelah ini.')) return;
            
            try {
                await db.completeTicket(currentTicketEventId);
                showCelebration();
            } catch (error) {
                showNotification('error', 'Gagal menyelesaikan tiket');
            }
        }

        function showCelebration() {
            const overlay = document.getElementById('celebration-overlay');
            const confettiContainer = document.getElementById('confetti-container');
            
            overlay.style.display = 'flex';
            confettiContainer.innerHTML = '';
            
            const colors = ['#fbbf24', '#10b981', '#3b82f6', '#ef4444', '#8b5cf6', '#ec4899', '#f97316'];
            
            // Confetti
            for (let i = 0; i < 200; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.animationDuration = (3 + Math.random() * 2) + 's';
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                confettiContainer.appendChild(confetti);
            }
            
            // Fireworks
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'firework';
                    firework.style.left = (20 + Math.random() * 60) + '%';
                    firework.style.top = (20 + Math.random() * 40) + '%';
                    firework.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confettiContainer.appendChild(firework);
                }, i * 150);
            }
            
            // Stars
            const stars = ['â­', 'ðŸŒŸ', 'âœ¨', 'ðŸ’«', 'ðŸŽ‰', 'ðŸŽŠ', 'ðŸŒ™', 'â˜ªï¸'];
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const star = document.createElement('div');
                    star.className = 'star-burst';
                    star.textContent = stars[Math.floor(Math.random() * stars.length)];
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    confettiContainer.appendChild(star);
                }, i * 80);
            }
            
            setTimeout(() => {
                overlay.style.display = 'none';
                currentTicketEventId = null;
                document.getElementById('ticket-screen').classList.add('hidden');
                document.getElementById('user-dashboard').classList.remove('hidden');
            }, 5000);
        }

        // ============================================
        // SCANNER
        // ============================================
        function openScanner() {
            document.getElementById('scanner-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
            updateScannerStatus('loading', 'Memuat kamera...');
            startScanner();
        }

        function startScanner() {
            const readerElement = document.getElementById('qr-reader');
            readerElement.innerHTML = '';
            
            qrScanner = new Html5Qrcode("qr-reader");
            
            const screenWidth = window.innerWidth;
            let qrboxSize = Math.min(250, screenWidth - 100);
            if (screenWidth < 400) qrboxSize = 180;
            
            qrScanner.start(
                { facingMode: currentFacingMode },
                { fps: 10, qrbox: { width: qrboxSize, height: qrboxSize } },
                onScanSuccess,
                () => {}
            ).then(() => {
                scannerIsRunning = true;
                updateScannerStatus('success', 'Arahkan ke QR Code');
            }).catch(err => {
                if (currentFacingMode === "environment") {
                    currentFacingMode = "user";
                    startScanner();
                } else {
                    updateScannerStatus('error', 'Gagal mengakses kamera');
                    showFileUploadFallback();
                }
            });
        }

        function updateScannerStatus(type, message) {
            const statusEl = document.getElementById('scanner-status');
            const configs = {
                loading: { icon: 'fa-spinner fa-spin', bg: 'bg-blue-50', text: 'text-blue-700' },
                success: { icon: 'fa-camera', bg: 'bg-green-50', text: 'text-green-700' },
                error: { icon: 'fa-exclamation-triangle', bg: 'bg-red-50', text: 'text-red-700' }
            };
            const cfg = configs[type];
            statusEl.className = `mb-3 p-3 rounded-lg text-center ${cfg.bg}`;
            statusEl.innerHTML = `<i class="fas ${cfg.icon} mr-2"></i><span class="text-sm ${cfg.text}">${message}</span>`;
        }

        function showFileUploadFallback() {
            document.getElementById('qr-reader').innerHTML = `
                <div class="p-6 text-center bg-gray-100 rounded-xl">
                    <i class="fas fa-camera-retro text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 mb-4">Kamera tidak tersedia</p>
                    <label class="btn-primary text-white py-3 px-6 rounded-lg cursor-pointer inline-block">
                        <i class="fas fa-upload mr-2"></i>Upload Gambar QR
                        <input type="file" accept="image/*" onchange="handleFileUpload(event)" class="hidden">
                    </label>
                </div>
            `;
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            Html5Qrcode.scanFile(file, true)
                .then(onScanSuccess)
                .catch(() => updateScannerStatus('error', 'QR tidak ditemukan'));
        }

        function switchCamera() {
            if (!scannerIsRunning) { startScanner(); return; }
            currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
            updateScannerStatus('loading', 'Mengganti kamera...');
            qrScanner.stop().then(() => { scannerIsRunning = false; startScanner(); });
        }

        function closeScanner() {
            if (qrScanner && scannerIsRunning) {
                qrScanner.stop().then(() => {
                    scannerIsRunning = false;
                    document.getElementById('scanner-modal').classList.remove('active');
                    document.body.style.overflow = '';
                });
            } else {
                document.getElementById('scanner-modal').classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        async function onScanSuccess(decodedText) {
            try {
                // Try to parse as JSON first (dari scanner website)
                try {
                    const data = JSON.parse(decodedText);
                    if (data.type === 'event-qr') {
                        await processQRData(data.eventId, data.timestamp);
                        return;
                    }
                } catch (jsonError) {
                    // Not JSON, try as URL (dari aplikasi QR eksternal)
                }
                
                // Try to parse as URL
                if (decodedText.includes('#join?')) {
                    const url = new URL(decodedText);
                    const hash = url.hash;
                    const params = new URLSearchParams(hash.substring(6));
                    const eventId = params.get('eventId');
                    const eventCode = params.get('code');
                    const timestamp = params.get('ts');
                    
                    if (eventId && eventCode && timestamp) {
                        await processQRData(eventId, timestamp, eventCode);
                        return;
                    }
                }
                
                throw new Error('Invalid QR format');
            } catch (e) {
                showNotification('error', 'QR Code tidak valid!');
            }
        }
        
        async function processQRData(eventId, timestamp, eventCode = null) {
            const event = cachedEvents.find(e => {
                if (eventCode) {
                    return e.id === eventId && e.eventCode === eventCode;
                }
                return e.id === eventId;
            });
            
            if (!event) {
                showNotification('error', 'Event tidak ditemukan');
                return;
            }
            
            // Check expiry (6 seconds)
            const qrTime = new Date(timestamp);
            const diffSeconds = (new Date() - qrTime) / 1000;
            
            if (diffSeconds > 6) {
                showNotification('error', 'QR Code kadaluarsa! Scan yang baru.');
                return;
            }
            
            // Check kuota
            const visitorsCount = event.visitors ? Object.keys(event.visitors).length : 0;
            const quota = event.quota || 0;
            if (quota > 0 && visitorsCount >= quota) {
                showNotification('error', 'Kuota event sudah penuh!');
                closeScanner();
                return;
            }
            
            if (cachedTickets.some(t => t.eventId === event.id)) {
                showNotification('error', 'Anda sudah terdaftar!');
                closeScanner();
                return;
            }
            
            await registerToEvent(event);
            closeScanner();
        }

        async function registerToEvent(event) {
            const deviceId = db.getDeviceId();
            const deviceInfo = getDeviceInfo();
            
            try {
                const exists = await db.checkVisitorExists(event.id, deviceId);
                if (exists) {
                    showNotification('error', 'Device sudah terdaftar!');
                    return;
                }
                
                // Check kuota lagi sebelum register
                const visitorsCount = event.visitors ? Object.keys(event.visitors).length : 0;
                const quota = event.quota || 0;
                if (quota > 0 && visitorsCount >= quota) {
                    showNotification('error', 'Kuota event sudah penuh!');
                    return;
                }
                
                await db.addVisitor(event.id, { deviceInfo });
                await db.createTicket({ eventId: event.id, eventName: event.name });
                
                showNotification('success', 'âœ… Berhasil bergabung: ' + event.name);
            } catch (error) {
                showNotification('error', 'Gagal mendaftar');
            }
        }

        function getDeviceInfo() {
            const ua = navigator.userAgent;
            let device = 'Unknown';
            
            if (/android/i.test(ua)) {
                device = 'Android';
                const match = ua.match(/Android\s([0-9\.]*)/);
                if (match) device += ' ' + match[1];
            } else if (/iPad|iPhone|iPod/.test(ua)) {
                device = 'iOS';
            } else if (/Windows/.test(ua)) {
                device = 'Windows';
            } else if (/Mac/.test(ua)) {
                device = 'Mac';
            }
            
            let browser = 'Unknown';
            if (ua.indexOf('Chrome') > -1) browser = 'Chrome';
            else if (ua.indexOf('Safari') > -1) browser = 'Safari';
            else if (ua.indexOf('Firefox') > -1) browser = 'Firefox';
            else if (ua.indexOf('Edge') > -1) browser = 'Edge';
            
            return { device, browser };
        }

        // ============================================
        // ADMIN DASHBOARD
        // ============================================
        function loadAdminDashboard() {
            db.onEventsChange(events => {
                cachedEvents = events;
                updateAdminStats();
                loadAdminEventsList();
            });
        }

        function updateAdminStats() {
            const now = new Date();
            const activeEvents = cachedEvents.filter(e => new Date(e.endDate) > now);
            
            let totalVisitors = 0;
            const uniqueDevices = new Set();
            
            cachedEvents.forEach(event => {
                if (event.visitors) {
                    Object.values(event.visitors).forEach(v => {
                        totalVisitors++;
                        uniqueDevices.add(v.deviceId);
                    });
                }
            });
            
            document.getElementById('total-events').textContent = cachedEvents.length;
            document.getElementById('active-events-count').textContent = activeEvents.length;
            document.getElementById('total-visitors').textContent = totalVisitors;
            document.getElementById('unique-devices').textContent = uniqueDevices.size;
        }

        function loadAdminEventsList() {
            const container = document.getElementById('admin-events-list');
            if (!container) return;
            
            if (cachedEvents.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada event. Buat event pertama!</p>';
                return;
            }
            
            container.innerHTML = cachedEvents.map(event => {
                const now = new Date();
                const isActive = new Date(event.endDate) > now;
                const visitorsCount = event.visitors ? Object.keys(event.visitors).length : 0;
                const quota = event.quota || 0;
                
                return `
                    <div class="border border-gray-200 rounded-xl p-4 hover:shadow-lg hover:border-emerald-400 transition-all cursor-pointer" onclick="showEventDetail('${event.id}')">
                        <div class="flex items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-gray-800 truncate">${event.name}</h4>
                                <p class="text-sm text-gray-500 truncate">${event.location} â€¢ ${formatDate(new Date(event.startDate))}</p>
                                <p class="text-xs text-emerald-600 font-mono mt-1">${event.eventCode}</p>
                            </div>
                            <div class="flex items-center gap-4 ml-4">
                                <div class="text-center">
                                    <p class="text-2xl font-bold text-gray-800">${visitorsCount}${quota > 0 ? '/' + quota : ''}</p>
                                    <p class="text-xs text-gray-500">Pengunjung</p>
                                </div>
                                <div class="${isActive ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'} px-3 py-1 rounded-full text-xs font-bold">
                                    ${isActive ? 'AKTIF' : 'SELESAI'}
                                </div>
                                <i class="fas fa-chevron-right text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // EVENT CRUD
        // ============================================
        function openCreateEventModal() {
            document.getElementById('create-event-modal').classList.add('active');
        }

        function closeCreateEventModal() {
            document.getElementById('create-event-modal').classList.remove('active');
            document.getElementById('create-event-form').reset();
        }

        document.getElementById('create-event-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const eventData = {
                name: document.getElementById('event-name').value,
                description: document.getElementById('event-description').value,
                startDate: document.getElementById('event-start').value,
                endDate: document.getElementById('event-end').value,
                location: document.getElementById('event-location').value,
                quota: parseInt(document.getElementById('event-quota').value)
            };
            
            try {
                const { eventCode } = await db.createEvent(eventData);
                closeCreateEventModal();
                showNotification('success', 'Event berhasil dibuat! Kode: ' + eventCode);
            } catch (error) {
                showNotification('error', 'Gagal membuat event');
            }
        });

        function showEventDetail(eventId) {
            currentEventId = eventId;
            const event = cachedEvents.find(e => e.id === eventId);
            if (!event) return;
            
            const now = new Date();
            const isActive = new Date(event.endDate) > now;
            const visitorsCount = event.visitors ? Object.keys(event.visitors).length : 0;
            const quota = event.quota || 0;
            
            document.getElementById('detail-event-name').textContent = event.name;
            document.getElementById('detail-event-desc').textContent = event.description;
            document.getElementById('detail-event-location').textContent = event.location;
            document.getElementById('detail-event-start').textContent = formatDate(new Date(event.startDate));
            document.getElementById('detail-event-end').textContent = formatDate(new Date(event.endDate));
            document.getElementById('detail-event-code').textContent = event.eventCode;
            document.getElementById('detail-event-status').innerHTML = isActive ? 
                '<span class="text-green-600 font-bold">AKTIF</span>' : 
                '<span class="text-gray-500 font-bold">SELESAI</span>';
            document.getElementById('detail-event-quota').innerHTML = quota > 0 ? 
                `<span class="font-bold ${visitorsCount >= quota ? 'text-red-600' : 'text-emerald-700'}">${visitorsCount}/${quota}</span>` : 
                '<span class="text-gray-500">Tidak ada limit</span>';
            
            // Update stat displays
            document.getElementById('detail-visitors-count-display').textContent = visitorsCount;
            document.getElementById('detail-quota-display').textContent = quota > 0 ? (quota - visitorsCount) : 'âˆž';
            
            loadVisitorsTable(event);
            
            // Listen for real-time visitor updates
            previousVisitorCount = visitorsCount;
            db.onEventVisitorsChange(eventId, visitors => {
                const event = cachedEvents.find(e => e.id === eventId);
                if (event) {
                    event.visitors = {};
                    visitors.forEach(v => { event.visitors[v.deviceId] = v; });
                    loadVisitorsTable(event);
                    
                    // Update quota display
                    const newCount = visitors.length;
                    document.getElementById('detail-event-quota').innerHTML = quota > 0 ? 
                        `<span class="font-bold ${newCount >= quota ? 'text-red-600' : 'text-emerald-700'}">${newCount}/${quota}</span>` : 
                        '<span class="text-gray-500">Tidak ada limit</span>';
                    
                    // Update stat displays
                    const visitorsCountEl = document.getElementById('detail-visitors-count-display');
                    const quotaDisplayEl = document.getElementById('detail-quota-display');
                    if (visitorsCountEl) visitorsCountEl.textContent = newCount;
                    if (quotaDisplayEl) quotaDisplayEl.textContent = quota > 0 ? (quota - newCount) : 'âˆž';
                    
                    // Check for new visitor
                    if (visitors.length > previousVisitorCount) {
                        const newVisitor = visitors[visitors.length - 1];
                        showNotification('success', 'ðŸŽ‰ Pengunjung baru: ' + (newVisitor.deviceInfo?.device || 'Device'));
                    }
                    previousVisitorCount = visitors.length;
                }
            });
            
            document.getElementById('event-detail-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            setTimeout(() => startQRRefresh(event), 100);
        }

        function closeEventDetailModal() {
            document.getElementById('event-detail-modal').classList.remove('active');
            document.body.style.overflow = '';
            stopQRRefresh();
            if (currentEventId) {
                db.offEventVisitorsChange(currentEventId);
            }
        }

        function loadVisitorsTable(event) {
            const tbody = document.getElementById('visitors-table-body');
            const visitors = event.visitors ? Object.values(event.visitors) : [];
            
            document.getElementById('detail-visitors-count').textContent = visitors.length;
            
            if (visitors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500">Belum ada pengunjung</td></tr>';
                return;
            }
            
            tbody.innerHTML = visitors.map((v, i) => `
                <tr class="hover:bg-gray-100 ${i === visitors.length - 1 ? 'visitor-new' : ''}">
                    <td class="px-4 py-3 font-semibold">${i + 1}</td>
                    <td class="px-4 py-3">${v.timestamp ? formatDate(new Date(v.timestamp)) : '-'}</td>
                    <td class="px-4 py-3"><code class="bg-gray-200 px-2 py-1 rounded text-xs">${v.deviceId || '-'}</code></td>
                    <td class="px-4 py-3">${v.deviceInfo?.device || '-'}</td>
                    <td class="px-4 py-3">${v.deviceInfo?.browser || '-'}</td>
                </tr>
            `).join('');
        }

        // QR Refresh
        function startQRRefresh(event) {
            stopQRRefresh();
            
            function generateQR() {
                const timestamp = new Date().toISOString();
                // URL untuk scan dari aplikasi eksternal
                const currentURL = window.location.origin + window.location.pathname;
                const qrURL = `${currentURL}#join?eventId=${event.id}&code=${event.eventCode}&ts=${encodeURIComponent(timestamp)}`;
                
                // Calculate QR size (50% of viewport width, max 600px, min 250px)
                const viewportWidth = window.innerWidth;
                let qrSize = Math.floor(viewportWidth * 0.5); // 50% dari layar
                qrSize = Math.min(qrSize, 600); // maksimal 600px
                qrSize = Math.max(qrSize, 250); // minimal 250px
                
                // Responsive adjustment
                if (viewportWidth < 640) { // mobile
                    qrSize = Math.floor(viewportWidth * 0.7); // 70% untuk mobile
                    qrSize = Math.min(qrSize, 400);
                }
                
                // Large QR in detail modal
                const qrContainer = document.getElementById('detail-event-qr');
                if (qrContainer) {
                    qrContainer.innerHTML = '';
                    new QRCode(qrContainer, {
                        text: qrURL,
                        width: qrSize,
                        height: qrSize,
                        colorDark: "#047857",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                }
            }
            
            generateQR();
            
            // Refresh QR setiap 5 detik
            qrRefreshInterval = setInterval(() => {
                generateQR();
            }, 5000);
            
            // Re-generate on window resize
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(generateQR, 300);
            });
        }

        function stopQRRefresh() {
            if (qrRefreshInterval) {
                clearInterval(qrRefreshInterval);
                qrRefreshInterval = null;
            }
        }

        // Edit Event
        function openEditEventModal() {
            const event = cachedEvents.find(e => e.id === currentEventId);
            if (!event) return;
            
            document.getElementById('edit-event-name').value = event.name;
            document.getElementById('edit-event-description').value = event.description;
            document.getElementById('edit-event-start').value = event.startDate;
            document.getElementById('edit-event-end').value = event.endDate;
            document.getElementById('edit-event-location').value = event.location;
            document.getElementById('edit-event-quota').value = event.quota || 0;
            
            document.getElementById('edit-event-modal').classList.add('active');
        }

        function closeEditEventModal() {
            document.getElementById('edit-event-modal').classList.remove('active');
        }

        document.getElementById('edit-event-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const updatedData = {
                name: document.getElementById('edit-event-name').value,
                description: document.getElementById('edit-event-description').value,
                startDate: document.getElementById('edit-event-start').value,
                endDate: document.getElementById('edit-event-end').value,
                location: document.getElementById('edit-event-location').value,
                quota: parseInt(document.getElementById('edit-event-quota').value)
            };
            
            try {
                await db.updateEvent(currentEventId, updatedData);
                closeEditEventModal();
                closeEventDetailModal();
                showNotification('success', 'Event berhasil diupdate!');
            } catch (error) {
                showNotification('error', 'Gagal update event');
            }
        });

        // Delete Event
        async function deleteEvent() {
            if (!confirm('Hapus event ini?\nSemua data pengunjung akan terhapus!')) return;
            
            try {
                await db.deleteEvent(currentEventId);
                closeEventDetailModal();
                showNotification('success', 'Event berhasil dihapus!');
            } catch (error) {
                showNotification('error', 'Gagal menghapus event');
            }
        }

        // Export to Excel
        function exportVisitors() {
            const event = cachedEvents.find(e => e.id === currentEventId);
            if (!event) return;
            
            const visitors = event.visitors ? Object.values(event.visitors) : [];
            
            if (visitors.length === 0) {
                showNotification('error', 'Tidak ada data untuk diexport');
                return;
            }
            
            const data = visitors.map((v, i) => ({
                'No': i + 1,
                'Waktu Scan': v.timestamp ? formatDate(new Date(v.timestamp)) : '-',
                'Device ID': v.deviceId || '-',
                'Device': v.deviceInfo?.device || '-',
                'Browser': v.deviceInfo?.browser || '-'
            }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Pengunjung');
            
            // Auto-fit columns
            const colWidths = [
                { wch: 5 },
                { wch: 20 },
                { wch: 15 },
                { wch: 15 },
                { wch: 12 }
            ];
            ws['!cols'] = colWidths;
            
            XLSX.writeFile(wb, `Pengunjung_${event.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showNotification('success', 'File Excel berhasil didownload!');
        }

        // ============================================
        // UTILITIES
        // ============================================
        function formatDate(date) {
            return date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showNotification(type, message) {
            const container = document.getElementById('notification-container');
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} text-2xl"></i>
                <span>${message}</span>
            `;
            container.appendChild(notif);
            
            setTimeout(() => notif.remove(), 4000);
        }

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                    document.body.style.overflow = '';
                    stopQRRefresh();
                }
            });
        });
    </script>
</body>
</html>
